# useCredits Hook

Hook for accessing and managing credits balance with real-time updates.

## Location

**Import Path**: `@umituz/react-native-subscription`

**File**: `src/presentation/hooks/useCredits.ts`

**Type**: Hook

## Strategy

### Data Fetching Flow

1. **Initial Load**
   - Fetch credits from repository on mount
   - Cache results in TanStack Query
   - Handle loading/error states

2. **Real-time Updates**
   - Subscribe to credit changes via repository listener
   - Auto-update on balance changes
   - Invalidate query on external modifications

3. **Cache Management**
   - Use TanStack Query for caching
   - Background refetch on window focus
   - Manual refetch capability

### Integration Points

- **Credits Repository**: `src/domains/wallet/infrastructure/repositories/CreditsRepository.ts`
- **Credits Entity**: `src/domains/wallet/domain/entities/UserCredits.ts`
- **TanStack Query**: For cache management and background updates
- **useFocusEffect**: For refresh on screen focus

## Restrictions

### REQUIRED

- **User Authentication**: User MUST be authenticated to access credits
- **Error Handling**: MUST handle error state in UI
- **Loading State**: MUST show loading indicator while fetching

### PROHIBITED

- **NEVER** assume credits are available without checking loading state
- **NEVER** use this hook for unauthenticated users
- **DO NOT** mutate credits directly - use `useDeductCredit` instead
- **DO NOT** call refetch excessively (causes unnecessary network calls)

### CRITICAL SAFETY

- **ALWAYS** check `isLoading` before displaying credits
- **ALWAYS** handle `error` state to prevent crashes
- **NEVER** use `credits` value for security decisions (validate on backend)
- **MUST** implement error boundaries when displaying balance

## Rules

### Basic Usage

```typescript
// CORRECT - Handle all states
function CreditsDisplay() {
  const { credits, isLoading, error } = useCredits();

  if (isLoading) return <ActivityIndicator />;
  if (error) return <ErrorDisplay error={error} />;

  return <Text>Credits: {credits}</Text>;
}

// INCORRECT - No loading check
function CreditsDisplay() {
  const { credits } = useCredits();
  return <Text>Credits: {credits}</Text>; // May show undefined
}

// INCORRECT - No error handling
function CreditsDisplay() {
  const { credits, isLoading, error } = useCredits();

  if (isLoading) return <ActivityIndicator />;
  return <Text>Credits: {credits}</Text>; // Crashes if error
}
```

### Manual Refresh

```typescript
// CORRECT - Manual refetch with loading state
function CreditsWithRefresh() {
  const { credits, refetch, isLoading } = useCredits();

  const handleRefresh = async () => {
    await refetch();
  };

  return (
    <Button onPress={handleRefresh} disabled={isLoading}>
      Refresh
    </Button>
  );
}

// INCORRECT - Ignore loading state during refresh
const handleRefresh = () => {
  refetch(); // No loading indication
};
```

### Transaction History

```typescript
// CORRECT - Display transactions with safety checks
function CreditsWithHistory() {
  const { credits, transactions, isLoading } = useCredits();

  if (isLoading) return <ActivityIndicator />;

  return (
    <View>
      <Text>Credits: {credits}</Text>
      <FlatList
        data={transactions || []}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => <TransactionItem {...item} />}
      />
    </View>
  );
}

// INCORRECT - Assume transactions exist
<FlatList
  data={transactions} // Crashes if undefined
  keyExtractor={(item) => item.id}
  renderItem={({ item }) => <TransactionItem {...item} />}
/>
```

### Auto-Refresh Patterns

```typescript
// CORRECT - Refresh on focus with effect cleanup
function AutoRefreshCredits() {
  const { credits, refetch } = useCredits();

  useFocusEffect(
    useCallback(() => {
      refetch();
    }, [refetch])
  );

  return <Text>Credits: {credits}</Text>;
}

// INCORRECT - Missing dependency
useFocusEffect(
  useCallback(() => {
    refetch();
  }, []) // Missing refetch dependency
);
```

### Balance Display

```typescript
// CORRECT - Safe balance display with formatting
function BalanceDisplay() {
  const { credits, balance, isLoading } = useCredits();

  if (isLoading) return <Skeleton />;

  return (
    <View>
      <Text>{credits} Credits</Text>
      <Text>Value: ${(balance || 0).toFixed(2)}</Text>
    </View>
  );
}

// INCORRECT - Unsafe balance access
<Text>Value: ${balance.toFixed(2)}</Text> // Crashes if undefined
```

## AI Agent Guidelines

### When Implementing Credit Displays

1. **Always** handle loading state explicitly
2. **Always** handle error state gracefully
3. **Always** provide manual refresh option
4. **Always** format balance safely (handle undefined/null)
5. **Never** use credits for security decisions (server-side validation required)

### Integration Checklist

- [ ] Import from correct path: `@umituz/react-native-subscription`
- [ ] Handle loading state in UI
- [ ] Handle error state in UI
- [ ] Provide refresh mechanism
- [ ] Format balance safely with default values
- [ ] Implement error boundaries
- [ ] Test with no credits (zero balance)
- [ ] Test with loading states
- [ ] Test with error states
- [ ] Test refresh functionality

### Common Patterns to Implement

1. **Balance Card**: Display credits with currency conversion
2. **Transaction List**: Show recent credit activity
3. **Low Credits Warning**: Alert when balance is low
4. **Refresh Control**: Pull-to-refresh or button
5. **Real-time Updates**: Use focus effect for auto-refresh
6. **Purchase Prompt**: Link to credit packages when low
7. **Skeletal Loading**: Show skeleton during initial load
8. **Error Recovery**: Retry mechanism for failed fetches

## Related Documentation

- **useDeductCredit**: Deduct credits from balance
- **useCreditChecker**: Check credit availability before operations
- **useInitializeCredits**: Initialize credits after purchase
- **useCreditsGate**: Gate features behind credit requirements
- **useFeatureGate**: Unified feature gating with credits
- **Credits Repository**: `src/domains/wallet/infrastructure/repositories/README.md`
- **Wallet Domain**: `src/domains/wallet/README.md`
